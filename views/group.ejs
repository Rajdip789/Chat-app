<%- include('layouts/header.ejs') %>

	<% if(typeof GroupJoinResData !== 'undefined') { %>
		<div class="app__flex flex-column p-4" style="height: 95%;">
			<div class="rounded bg-light m-2">
				<img src=<%= process.env.ORIGIN_URL %>/<%= GroupJoinResData.group.image %> alt="user logo" height="100px">
			</div>
			<div class="app__flex flex-column m-2 text-white">
				<h4 class="text-white"><%= GroupJoinResData.group.name %></h4>
				<p>Total Members: <%= GroupJoinResData.totalMembers %></p>
				
				<%
					if(GroupJoinResData.available != 0) {
						%>
							<p>Available for <b> <%= GroupJoinResData.available %> </b> Members</p>
						<%
					} 
					
					if(GroupJoinResData.isAdmin) {
						%>
							<p>You are the creator of this group!</p>
							<a href="/dashboard" class="btn btn-light">Back to Home</a>
						<%
					} else if(GroupJoinResData.isJoined != 0) {
						%>
							<p> You have already joined the Group</p>
							<a href="/dashboard" class="btn btn-light">Back to Home</a>
						<%
					} else {
						%>
							<button class="btn btn-light join_by_shared_link" data-id="<%= GroupJoinResData.group._id %>">Join Group</button>
						<%
					}
				%>
			</div>
		</div>
	<% } else { %>

	<div class="row">
		<div class="col-md-3">
			<ul class="list-group">

				<% if(myGroups.length == 0 && joinedGroups.length == 0) { %>
					<h3>No Groups found!</h3>
				<% } %>

				<!--------- My Groups ------------->
				<% if(myGroups.length> 0) {
					for(let i = 0; i< myGroups.length; i++) { %>
						<li class="list-group-item group-list app__flex" data-id="<%= myGroups[i]._id %>" data-name="<%= myGroups[i].name %>" data-image="<%= myGroups[i].image %>" data-description="<%= myGroups[i].description %>">
							<div class="app__flex group__image">
								<img src=<%= process.env.ORIGIN_URL %>/<%= myGroups[i].image %> alt="user logo" height="70%">
							</div>
							<div class="flex-grow-1">
								<%= myGroups[i].name %>
							</div>

							<!-- Drowdown to show group operations -->
							<div class="dropdown arrow">
								<div class="dropdown-toggle btn-lg" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								</div>
								<div class="dropdown-menu dropdown-menu-right" data-id="<%= myGroups[i]._id %>" aria-labelledby="dropdownMenuButton">
									<a class="dropdown-item text-secondary small addMember" data-toggle="modal" data-target="#AddMembersModal">Add/Remove Member</a>
									<a class="dropdown-item text-secondary small updateGroup" data-toggle="modal" data-target="#UpdateGroupModal" data-obj="<%= JSON.stringify(myGroups[i]) %>">Edit Group</a>
									<a class="dropdown-item text-secondary small deleteGroup" >Delete Group</a>
									<a class="dropdown-item text-secondary small groupLink" >Copy Link</a>
								</div>
							</div>

							<!-- Modal for Add/Remove Members in Group -->
							<div class="modal fade" id="AddMembersModal" tabindex="-1" role="dialog"
								aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
								<div class="modal-dialog modal-dialog-centered" role="document">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title" id="exampleModalCenterTitle">Add / Remove Members</h5>
											<button type="button" class="close" data-dismiss="modal" aria-label="Close">
												<span aria-hidden="true">&times;</span>
											</button>
										</div>

										<form action="" method="POST" id="add-member-form">
											<div class="modal-body">
												
												<input type="hidden" name="group_id" id="group-update-id"/>
											
												<div class="table__container">
													<table class="table">
														<thead>
															<th>Select</th>
															<th>Name</th>
														</thead>
														<tbody class="addMemberTable">
														</tbody>
													</table>
												</div>
											</div>
										</form>
										<div class="modal-footer">
											<p id="add-member-error" style="color: red"></p>
											<button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
											<button type="submit" class="btn btn-dark" form="add-member-form">Update</button>
										</div>
									</div>
								</div>
							</div>

							<!-- Modal for Update Group -->
							<div class="modal fade" id="UpdateGroupModal" tabindex="-1" role="dialog"
								aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
								<div class="modal-dialog modal-dialog-centered" role="document">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title" id="exampleModalCenterTitle">Update Group</h5>
											<button type="button" class="close" data-dismiss="modal" aria-label="Close">
												<span aria-hidden="true">&times;</span>
											</button>
										</div>
				
										<form action="" method="POST" enctype="multipart/form-data" id="update-group-form">
											<div class="modal-body app__flex flex-column">

												<input type="hidden" name="group_id" id="group-update-id"/>
												<input type="file" name="image" class="w-50 mb-2" id="group-image" />
												<input type="text" name="name" placeholder="Group name" class="group__input" id="group-name" required />
												<input type="text" name="description" placeholder="Description" class="group__input" id="group-description"/>
											</div>
											
											<div class="modal-footer">
												<button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
												<button type="submit" class="btn btn-dark">Update</button>
											</div>
										</form>
									</div>
								</div>
							</div>

						</li>

						
						<% } 
					}

					<!--------- Joined Groups --------->
					if(joinedGroups.length> 0) {
						for(let i = 0; i< joinedGroups.length; i++) { %>
							<li class="list-group-item group-list app__flex" data-id="<%= joinedGroups[i].group_id._id %>" data-name="<%= joinedGroups[i].group_id.name %>" data-image="<%= joinedGroups[i].group_id.image %>" data-description="<%= joinedGroups[i].group_id.description %>">
								<div class="app__flex group__image">
									<img src=<%= process.env.ORIGIN_URL %>/<%= joinedGroups[i].group_id.image %> alt="user logo" height="70%">
								</div>
								<div class="flex-grow-1">
									<%= joinedGroups[i].group_id.name %>
								</div>
	
								<!-- Drowdown to show group operations -->
								<div class="dropdown arrow">
									<div class="dropdown-toggle btn-lg" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
									</div>
									<div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
										<a class="dropdown-item text-secondary small leaveGroup" data-id="<%= joinedGroups[i].group_id._id %>">Leave Group</a>
									</div>
								</div>
	
							</li>
							
							<% } 
					}  	%>

			</ul>
		</div>
		<div class="app__flex col-md-9 p-2" id="start-chat">
			<button type="button" class="btn btn-primary btn-lg group-btn" data-toggle="modal" data-target="#CreateGroupModel">Create New Group</button>

			<!-- Modal for Create Group -->
			<div class="modal fade" id="CreateGroupModel" tabindex="-1" role="dialog"
				aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="exampleModalCenterTitle">Create Group</h5>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>

						<form action="" method="POST" enctype="multipart/form-data">
							<div class="modal-body app__flex flex-column">
								<input type="hidden" name="group_id" id="group-id"/>
							  	<input type="file" name="image" class="w-50 mb-2" accept=".png, .jpg, .jpeg" required />
							  	<input type="text" name="name" placeholder="Group name" class="group__input" required />
							  	<input type="text" name="description" placeholder="Description" class="group__input" />
							</div>
							
							<div class="modal-footer">
							  <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
							  <button type="submit" class="btn btn-dark">Create</button>
							</div>
						</form>
					</div>
				</div>
			</div>


			<!-- Chat Section -->
			<div class="chat-section">
				<div class="group-headline app__flex">
					<div>
						<img class="group__image rounded-pill" style="height: 35px;" src="" alt="group-logo"/>
					</div>
					<span class="group__name" style="font-weight: bold; font-size: large;"></span>
					<span class="group__description" style="margin-left: 1rem;"></span>
				</div>
				<div id="group-chat-container">
					<!-- <div class="current-user-chat">Hi</div>
				<div class="opposite-user-chat">Hi</div> -->
				</div>

				<form action="" id="group-chat-form" class="app__flex">
					<input type="text" name="message" placeholder="Enter message" id="group-message" class="message" required>
					<button type="submit" value="" class="btn btn-secondary">
						<i class="fa fa-paper-plane send" aria-hidden="true"></i>
					</button>
				</form>
			</div>
		</div>
	</div>

	<% } %>

	<%- include('layouts/footer.ejs') %>